<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TinyMCE with Letterhead</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/node_modules/tinymce/tinymce.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="/node_modules/air-datepicker/air-datepicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        window.jsPDF = window.jspdf.jsPDF;
    </script>

    <link rel="stylesheet" href="/node_modules/air-datepicker/air-datepicker.css">
</head>

  <body class="bg-gray-100 p-6">
    
    <!-- Header -->
    <div class="flex items-center rounded text-[#2C3E50] mb-4">
      <span class="text-[#F6AA04] font-bold text-xl mr-2">|</span>
      <h2 class="font-bold text-xl">Detail Working Order</h2>
    </div>

    <div class="flex justify-start">
        <button
          onclick="generateFullDoc()"
          class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 mr-2"
        >
          Preview Full Document
        </button>
        <button
          class="mb-4 px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 mr-2"
        >
          Save Changes
        </button>
         <button
  onclick="generatePDF()"
  id="buttonpdf"
  class="mb-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
>
  View As PDF
</button>

      </div>
      

    <!-- Wrapper for all content -->
    <div class="mb-4 bg-white border shadow mx-auto" style="width: 21cm; min-height: 29.7cm; padding: 2cm; font-size: 10pt;">

      <!-- Letterhead -->
      <div id="letterhead">
        <div class="flex justify-between items-center">
          <img src="https://placehold.co/100x50" alt="Logo 1" />
          <div class="text-center text-sm">
            <p class="font-bold">PT Niterra Mobility Indonesia</p>
            <p>Jl. Raya Jakarta-Bogor Km. 26,6 Ciracas</p>
            <p>Jakarta Timur, Indonesia</p>
          </div>
          <img src="https://placehold.co/80x50" alt="Logo 2" />
        </div>
        <hr class="mt-2 border-t border-black" />
        <hr class="mt-[1px] border-t border-black" />
        <p class="text-lg font-bold text-center underline mt-4">
          WORKING ORDER CONFIRMATION
        </p>
        <p id="number" class="text-sm font-bold text-center underline">##NUMBER##</p>
      </div>

      <!-- Letter Body -->
        <table id="letterbody" class="table-auto w-full mt-4">
          <tbody>
            <tr>
              <td class="align-top w-[170px]">To</td>
              <td><span id="vendor" name="vendor">##VENDOR##</span></td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">Attn</td>
              <td>
                <input
                  type="text"
                  name="attn"
                  id="attn"
                  class="border rounded w-full px-2"
                />
              </td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">Ref Quotation No & Date</td>
              <td>
                <input
                  type="text"
                  name="ref"
                  id="ref"
                  class="border rounded w-full px-2"
                />
              </td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">Project</td>
              <td>
                <input
                  type="text"
                  name="project"
                  id="project"
                  class="border rounded w-full px-2"
                />
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <textarea id="project-field" class="w-full mt-2">
                        <table class="table-auto border border-gray-400 border-collapse">
                          <thead>
                            <tr>
                              <th class="border border-gray-400 px-4 py-2">Song</th>
                              <th class="border border-gray-400 px-4 py-2">Artist</th>
                              <th class="border border-gray-400 px-4 py-2">Year</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr>
                              <td class="border border-gray-400 px-4 py-2">The Sliding Mr. Bones (Next Stop, Pottersville)</td>
                              <td class="border border-gray-400 px-4 py-2">Malcolm Lockyer</td>
                              <td class="border border-gray-400 px-4 py-2">1961</td>
                            </tr>
                            <tr>
                              <td class="border border-gray-400 px-4 py-2">Witchy Woman</td>
                              <td class="border border-gray-400 px-4 py-2">The Eagles</td>
                              <td class="border border-gray-400 px-4 py-2">1972</td>
                            </tr>
                            <tr>
                              <td class="border border-gray-400 px-4 py-2">Shining Star</td>
                              <td class="border border-gray-400 px-4 py-2">Earth, Wind, and Fire</td>
                              <td class="border border-gray-400 px-4 py-2">1975</td>
                            </tr>
                          </tbody>
                        </table>
                </textarea>
              </td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">Date</td>
              <td><span id="date" name="date">##DATENOW##</span></td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">Total</td>
              <td>
                <input
                  type="text"
                  name="total"
                  id="total"
                  class="border rounded w-full px-2"
                />
              </td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">Payment Term</td>
              <td>
                <input
                  type="text"
                  name="payment"
                  id="payment"
                  class="border rounded w-full px-2"
                />
              </td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">Start Date</td>
              <td>
                <input
                  type="text"
                  name="startDate"
                  id="startDate"
                  class="border rounded w-full px-2"
                />
              </td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">End Date</td>
              <td>
                <input
                  type="text"
                  name="endDate"
                  id="endDate"
                  class="border rounded w-full px-2"
                />
              </td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">BUDGET NO</td>
              <td>
                <select
                  name="budgetNo"
                  id="budgetNo"
                  class="border rounded w-full px-2"
                >
                  <option value="">Select Budget No</option>
                  <option value="1">Budget 1</option>
                  <option value="2">Budget 2</option>
                  <option value="3">Budget 3</option>
                </select>
              </td>
            </tr>
            <tr>
              <td class="align-top w-[170px]">Remark</td>
              <td>
                <input
                  type="text"
                  name="remark"
                  id="remark"
                  class="border rounded w-full px-2"
                />
              </td>
            </tr>
          </tbody>
        </table>
        <p>Please attach working order confirmation together with Invoice.</p>
      

      <!-- Approval Section -->
      <div id="approval">
        <div class="flex justify-end gap-12 mb-6">
          <div class="flex flex-col items-center gap-1">
            <div class="text-[12px]">Approved By:</div>
            <div class="w-12 h-12 bg-zinc-300 rounded-full"></div>
            <div class="text-[12px] font-bold">(##NAMEAPPROVED##)</div>
          </div>
          <div class="flex flex-col items-center gap-1">
            <div class="text-[12px]">Prepared By:</div>
            <div class="w-12 h-12 bg-zinc-300 rounded-full"></div>
            <div class="text-[12px] font-bold">(#NAMEPREPARED##)</div>
          </div>
        </div>
        <div class="flex flex-col items-start gap-1 mb-6 text-[10px] font-bold">
          <div class="mb-[50px]">CONFIRMATION RECEIVED BY SUPPLIER</div>
          <div>(NAME / SIGN / COMPANY STAMP)</div>
        </div>
      </div>
    </div>

   
    <!-- Combined Preview Output -->
        <div id="result" class="mt-6 flex justify-center hidden">

        <div style="width: 21cm; min-height: 29.7cm; padding: 2cm; font-size: 10pt;" class="bg-white border shadow text-[10pt]"></div>
      </div>

      <div id="previewModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-xl overflow-y-auto max-h-[90vh] w-[90vw] relative">
          <button
            onclick="closeModal()"
            class="absolute top-2 right-2 bg-red-500 text-white rounded-full px-3 py-1 text-xs hover:bg-red-600"
          >
            Close
          </button>
          <div id="modalContent" class="text-[10pt]"></div>
        </div>
      </div>
      

    <!-- TinyMCE Setup + Script -->
    <script>
      tinymce.init({
        selector: "#project-field",
        height: 300,
        plugins: "table code lists",
        toolbar:
          "undo redo | styles | bold italic | table | alignleft aligncenter alignright | bullist numlist  | code",
        menubar: false,
      });
// Tambahkan ini sebelum fungsi generatePDF()
function getDocumentData() {
  const projectContent = tinymce.get("project-field").getContent();

  const attn = document.getElementById("attn").value;
  const ref = document.getElementById("ref").value;
  const project = document.getElementById("project").value;
  const date = document.getElementById("date")?.innerText ?? "";
  const total = document.getElementById("total").value;
  const payment = document.getElementById("payment").value;
  const startDate = document.getElementById("startDate").value;
  const endDate = document.getElementById("endDate").value;
  const budgetNo = document.getElementById("budgetNo").value;
  const remark = document.getElementById("remark").value;
  const vendor = document.getElementById("vendor")?.innerText ?? "##VENDOR##";
  const number = document.getElementById("number")?.innerText ?? "##NUMBER##";

  return { 
    number,
    vendor,
    attn,
    ref,
    project,
    projectContent,
    date,
    total,
    payment,
    startDate,
    endDate,
    budgetNo,
    remark
  };
}


function generateFullDoc() {
  const data = getDocumentData();
  const letterhead = document.getElementById("letterhead").outerHTML;
  const approval = document.getElementById("approval").outerHTML;

  const letterbody = `
    <table class="table-auto w-full text-[10pt]">
      <tbody>
        <tr><td class="w-[170px] align-top">To</td><td>: ${data.vendor}</td></tr>
        <tr><td class="align-top">Attn</td><td>: ${data.attn}</td></tr>
        <tr><td class="align-top">Ref Quotation No & Date</td><td>: ${data.ref}</td></tr>
        <tr><td class="align-top">Project</td><td>: ${data.project}<br>${data.projectContent}</td></tr>
        <tr><td class="align-top">Date</td><td>: ${data.date}</td></tr>
        <tr><td class="align-top">Total</td><td>: ${data.total}</td></tr>
        <tr><td class="align-top">Payment Term</td><td>: ${data.payment}</td></tr>
        <tr><td class="align-top">Start Date</td><td>: ${data.startDate}</td></tr>
        <tr><td class="align-top">End Date</td><td>: ${data.endDate}</td></tr>
        <tr><td class="align-top">BUDGET NO</td><td>: ${data.budgetNo}</td></tr>
        <tr><td class="align-top">Remark</td><td>: ${data.remark}</td></tr>
      </tbody>
    </table>
    <p class="text-[10pt] mt-2">Please attach working order confirmation together with Invoice.</p>
  `;

  const fullDoc = `
    <div style="width: 21cm; min-height: 29.7cm; padding: 2cm; font-size: 10pt;" class="bg-white border shadow mx-auto">
      ${letterhead}
      <div class="mt-6">${letterbody}</div>
      <div class="mt-6">${approval}</div>
    </div>
  `;

  // Tampilkan ke modal
  document.getElementById("modalContent").innerHTML = fullDoc;
  document.getElementById("previewModal").classList.remove("hidden");
}



function generatePDF() {
  // Generate preview dulu
  generateFullDoc();
  
  // Ambil element dari modal preview
  const element = document.getElementById("modalContent").firstElementChild;
  
  html2canvas(element, {
    scale: 2,
    useCORS: true,
    logging: false
  }).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    
    const widthRatio = pageWidth / canvas.width;
    const heightRatio = pageHeight / canvas.height;
    const ratio = widthRatio > heightRatio ? heightRatio : widthRatio;
    
    const canvasWidth = canvas.width * ratio;
    const canvasHeight = canvas.height * ratio;
    
    const marginX = (pageWidth - canvasWidth) / 2;
    const marginY = 0;

    pdf.addImage(imgData, 'JPEG', marginX, marginY, canvasWidth, canvasHeight);

    // Buka PDF di tab baru
    const pdfBlob = pdf.output('blob');
    const blobUrl = URL.createObjectURL(pdfBlob);
    window.open(blobUrl, '_blank');
    
    // Tutup modal preview
    document.getElementById("previewModal").classList.add("hidden");
  });
}


function closeModal() {
  document.getElementById("previewModal").classList.add("hidden");
}

// Event listener untuk klik di luar konten modal
document.addEventListener("click", function (e) {
  const modal = document.getElementById("previewModal");
  const modalContent = document.getElementById("modalContent");
  if (!modal.classList.contains("hidden") && modal.contains(e.target) && !modalContent.contains(e.target)) {
    closeModal();
  }
});

document.addEventListener('DOMContentLoaded', function () {
  // Function to initialize the Air Datepicker
  function datepicker(selector) {
    new AirDatepicker(selector, {
      dateFormat: 'dd-MM-yyyy',
      minDate: new Date(),
      locale: {
        days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
        daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        daysMin: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
        months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
        monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
        today: "Today",
        clear: "Clear",
        firstDay: 0
      },
    });
  }

  // Initialize datepickers for both startDate and endDate
  datepicker("#startDate");
  datepicker("#endDate");
});


    </script>
  </body>
</html>
